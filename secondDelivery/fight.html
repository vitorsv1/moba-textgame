<!DOCTYPE html>
<html>
    <head>
        <title> RPG Fight</title>
        <meta name="description" content="Welcome to RPG Fight Online game, a Text based game for use NodeJS features">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="/css/style.css">
    </head>
    <body>
        <!-- HEADER -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand text-white">RPG Fight</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav">
                <a class="nav-item nav-link" href="./">Home <span class="sr-only">(current)</span></a>
                <a class="nav-item nav-link" href="./char-select">Char Select</a>
                <a class="nav-item nav-link active" href="./fight">Fight</a>
              </div>
            </div>
        </nav>
        <!-- MUSIC FIGHT AVAILABLE IN https://www.youtube.com/watch?v=QN9SduuzoC4 - MADE BY Randy Rodrigues-->
        <div class="text-right">
            <audio id="audio" controls autoplay loop>
                <source src="/music/fight.mp3" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>
        <br>
        <p class="font-weight-bold text-center">You can use "Attack", "Ability 1" or "Ability 2" against your opponent</p>
        <br>
        <!-- CHAT -->
        <div class="container-flude">
            <div class="msg-group center">
                <div class="input-group">
                    <textarea id="input-box" class="form-control" rows="1" placeholder="Say your command..."></textarea>
                    <span class="input-group-btn">
                        <button id="send-btn" class="btn btn-secondary btn-lg" type="button">Confirm</button>
                    </span>
                </div>
                <div class="messages">

                </div>
            </div>
        </div>
        <!-- SCRIPTS -->
        <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="/scripts/character.js" ></script>
        <!--<script src="/scripts/chat-control.js" ></script>-->
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io('http://localhost:3000');

            var audio = document.getElementById("audio");
            audio.volume = 0.1;

            $.urlParam = function (name) {
                var results = new RegExp('[\?&]' + name + '=([^&#]*)')
                                .exec(window.location.search);

                return (results !== null) ? results[1] || 0 : false;
            }

            var charName = $.urlParam('char1');
            var username = window.localStorage.getItem('username');

            // Find some way to pass the ROOM here 
            socket.emit('joinRoom', JSON.stringify({username : username, char: charName}));

            $.getJSON('./characterStats.json', function (data) {
                if(window.localStorage.getItem('trophy')==null) window.localStorage.setItem('trophy', '0');
                trophy = parseInt(window.localStorage.getItem('trophy'));
                ranger = new createCharacter(Ranger, data.character1.name, data.character1.hp + trophy*3,data.character1.attack + trophy*2, data.character1.ability1CD, data.character1.ability2CD,data.character1.description);
                mage = new createCharacter(Mage, data.character2.name, data.character2.hp + trophy*3,data.character2.attack + trophy*2, data.character2.ability1CD, data.character2.ability2CD,data.character2.description);
                fighter = new createCharacter(Fighter, data.character3.name, data.character3.hp + trophy*3,data.character3.attack + trophy*2, data.character3.ability1CD, data.character3.ability2CD,data.character3.description);
                const urlParams = new URLSearchParams(window.location.search);
                let char1;
                switch (urlParams.get('char1')) {
                    case 'archer': char1 = ranger; break;
                    case 'warrior': char1 = fighter; break;
                    case 'mage': char1 = mage; break;
                    default: throw "wrong char1 parameter: "+ urlParams;
                }
                game = new Fight(char1,fighter);

                console.log(char1.describe());
            });

            function renderMessage(messageObject, side){

                $('.messages').append(`<div class="card">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2 text-muted text-${side}">${messageObject.charname}</h6>
                                                <p class="card-text float-${side}">${messageObject.message}</p>
                                            </div>
                                        </div>`);
                
                $('.msg-group').scrollTop($('.msg-group')[0].scrollHeight);
            }

            socket.on('your turn', ()=>{
                var messageObject = {
                        id: socket.id,
                        charname: "Server",
                        message: "You start the fight"
                    };
                renderMessage(messageObject,'left');
            });

            socket.on('send command', (messageObject)=>{
                if(messageObject.id == socket.id){
                    renderMessage(messageObject, 'right');
                }
                else{
                    renderMessage(messageObject, 'left');
                }
            });

            socket.on('game finished', (message)=>{
                var message = "The game finished, " + message + "won!!";
                var msg = {
                        id: socket.id,
                        charname: "Server",
                        message: message
                    };
                renderMessage(msg,'left');
            });

            socket.on('send command2', (messageObject) => {
                if(messageObject.id == socket.id){
                    renderMessage(messageObject, 'right');
                }
                else{
                    renderMessage(messageObject, 'left');
                }
            });

            $('#send-btn').click(function(event){
                event.preventDefault();

                var message = $('#input-box').val();
                var commands = ["Attack", "Ability 1", "Ability 2"];
                
                if (message.length){
                    var messageObject = {
                        id: socket.id,
                        username: username,
                        charname: charName,
                        message: message
                    };

                    renderMessage(messageObject, 'right');

                    if(commands.includes(message)){
                        socket.emit('new comand', messageObject);
                    }
                    else{
                        socket.emit('new message', messageObject);
                    }
                }
            })
        </script>
    </body>
</html>
